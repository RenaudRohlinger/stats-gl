import{addMethodChaining as Q,nodeObject as H,vec4 as X,vec3 as V,screenUV as v,color as _,pass as Y,mrt as O,output as q,directionToColor as $,normalView as j,diffuseColor as Z,positionWorld as J,Fn as K,mix as w,step as G}from"https://unpkg.com/three@0.182.0/build/three.tsl.js";import*as p from"https://unpkg.com/three@0.182.0/build/three.webgpu.js";import{CanvasTarget as ee,NodeMaterial as te,QuadMesh as ie,RendererUtils as D,NoToneMapping as se,LinearSRGBColorSpace as re}from"https://unpkg.com/three@0.182.0/build/three.webgpu.js";import{GLTFLoader as ae}from"https://unpkg.com/three@0.182.0/examples/jsm/loaders/GLTFLoader.js";class ne{constructor(e,t,i){this.name=e,this.node=t,this.callback=i,this.canvas=null,this.canvasTarget=null,this.quad=null,this.material=null,this.initialized=!1,this.size=90}init(e){if(this.initialized)return!0;try{let t=this.node;this.callback!==null&&(t=this.callback(this.node)),t=H(t),this.canvas=new OffscreenCanvas(this.size,this.size),this.canvasTarget=new ee(this.canvas),this.canvasTarget.setPixelRatio(1),this.canvasTarget.setSize(this.size,this.size,!1);let i=X(V(t),1);return i=i.context({inspector:!0}),this.material=new te,this.material.outputNode=i,this.quad=new ie(this.material),this.initialized=!0,!0}catch(t){return console.warn("StatsGLWorker: Failed to initialize capture for",this.name,t),!1}}async capture(e){if(!this.initialized&&!this.init(e))return null;try{const t=e.getCanvasTarget(),i=D.resetRendererState(e);return e.toneMapping=se,e.outputColorSpace=re,e.setCanvasTarget(this.canvasTarget),this.quad.render(e),e.setCanvasTarget(t),D.restoreRendererState(e,i),await createImageBitmap(this.canvas)}catch(t){return console.warn("StatsGLWorker: Failed to capture for",this.name,t),null}}dispose(){this.material&&this.material.dispose&&this.material.dispose(),this.canvas=null,this.canvasTarget=null,this.quad=null,this.material=null,this.initialized=!1}}const U=new Map;function he(a,e,t=null,i=null){a=H(a);const s=new ne(e,a,i);return U.set(e,s),a}async function ue(a){const e=[];for(const[t,i]of U){const s=await i.capture(a);s&&e.push({name:t,bitmap:s})}return e}Q("toStatsGL",he);class M{constructor({trackGPU:e=!1,trackCPT:t=!1,trackHz:i=!1,trackFPS:s=!0,logsPerSecond:r=4,graphsPerSecond:h=30,samplesLog:n=40,samplesGraph:u=10,precision:l=2}={}){this.gl=null,this.ext=null,this.gpuDevice=null,this.gpuBackend=null,this.renderer=null,this.activeQuery=null,this.gpuQueries=[],this.threeRendererPatched=!1,this.webgpuNative=!1,this.gpuQuerySet=null,this.gpuResolveBuffer=null,this.gpuReadBuffers=[],this.gpuWriteBufferIndex=0,this.gpuFrameCount=0,this.pendingResolve=null,this.frameTimes=[],this.renderCount=0,this.totalCpuDuration=0,this.totalGpuDuration=0,this.totalGpuDurationCompute=0,this.averageFps={logs:[],graph:[]},this.averageCpu={logs:[],graph:[]},this.averageGpu={logs:[],graph:[]},this.averageGpuCompute={logs:[],graph:[]},this.trackGPU=e,this.trackCPT=t,this.trackHz=i,this.trackFPS=s,this.samplesLog=n,this.samplesGraph=u,this.precision=l,this.logsPerSecond=r,this.graphsPerSecond=h;const f=performance.now();this.prevGraphTime=f,this.beginTime=f,this.prevTextTime=f,this.prevCpuTime=f}async init(e){if(!e){console.error('Stats: The "canvas" parameter is undefined.');return}if(!this.handleThreeRenderer(e)&&!await this.handleWebGPURenderer(e)&&!this.handleNativeWebGPU(e))if(this.initializeWebGL(e)){this.trackGPU&&this.initializeGPUTracking();return}else console.error("Stats-gl: Failed to initialize WebGL context")}handleNativeWebGPU(e){var t;return e&&typeof e.createCommandEncoder=="function"&&typeof e.createQuerySet=="function"&&e.queue?(this.gpuDevice=e,this.webgpuNative=!0,this.trackGPU&&((t=e.features)!=null&&t.has("timestamp-query"))&&(this.initializeWebGPUTiming(),this.onWebGPUTimestampSupported()),!0):!1}initializeWebGPUTiming(){if(this.gpuDevice){this.gpuQuerySet=this.gpuDevice.createQuerySet({type:"timestamp",count:2}),this.gpuResolveBuffer=this.gpuDevice.createBuffer({size:16,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC});for(let e=0;e<2;e++)this.gpuReadBuffers.push(this.gpuDevice.createBuffer({size:16,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}))}}handleThreeRenderer(e){return e.isWebGLRenderer&&!this.threeRendererPatched?(this.patchThreeRenderer(e),this.gl=e.getContext(),this.trackGPU&&this.initializeGPUTracking(),!0):!1}async handleWebGPURenderer(e){var t;return e.isWebGPURenderer?(this.renderer=e,(this.trackGPU||this.trackCPT)&&(e.backend.trackTimestamp=!0,e._initialized||await e.init(),e.hasFeature("timestamp-query")&&this.onWebGPUTimestampSupported()),this.info=e.info,this.gpuBackend=e.backend,this.gpuDevice=((t=e.backend)==null?void 0:t.device)||null,this.patchThreeWebGPU(e),!0):!1}onWebGPUTimestampSupported(){}initializeWebGL(e){if(e instanceof WebGL2RenderingContext)this.gl=e;else if(e instanceof HTMLCanvasElement||e instanceof OffscreenCanvas){if(this.gl=e.getContext("webgl2"),!this.gl)return console.error("Stats: Unable to obtain WebGL2 context."),!1}else return console.error("Stats: Invalid input type. Expected WebGL2RenderingContext, HTMLCanvasElement, or OffscreenCanvas."),!1;return!0}initializeGPUTracking(){this.gl&&(this.ext=this.gl.getExtension("EXT_disjoint_timer_query_webgl2"),this.ext&&this.onGPUTrackingInitialized())}onGPUTrackingInitialized(){}getTimestampWrites(){if(!(!this.webgpuNative||!this.gpuQuerySet))return{querySet:this.gpuQuerySet,beginningOfPassWriteIndex:0,endOfPassWriteIndex:1}}begin(e){this.beginProfiling("cpu-started"),!this.webgpuNative&&(!this.gl||!this.ext||(this.activeQuery&&this.gl.endQuery(this.ext.TIME_ELAPSED_EXT),this.activeQuery=this.gl.createQuery(),this.activeQuery&&this.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,this.activeQuery)))}end(e){if(this.renderCount++,this.webgpuNative&&e&&this.gpuQuerySet&&this.gpuResolveBuffer&&this.gpuReadBuffers.length>0){this.gpuFrameCount++;const t=this.gpuReadBuffers[this.gpuWriteBufferIndex];t.mapState==="unmapped"&&(e.resolveQuerySet(this.gpuQuerySet,0,2,this.gpuResolveBuffer,0),e.copyBufferToBuffer(this.gpuResolveBuffer,0,t,0,16)),this.endProfiling("cpu-started","cpu-finished","cpu-duration");return}this.gl&&this.ext&&this.activeQuery&&(this.gl.endQuery(this.ext.TIME_ELAPSED_EXT),this.gpuQueries.push({query:this.activeQuery}),this.activeQuery=null),this.endProfiling("cpu-started","cpu-finished","cpu-duration")}async resolveTimestampsAsync(){if(!this.webgpuNative||this.gpuReadBuffers.length===0)return this.totalGpuDuration;if(this.pendingResolve)return this.pendingResolve;const e=(this.gpuWriteBufferIndex+1)%2,t=this.gpuReadBuffers[e];if(this.gpuWriteBufferIndex=(this.gpuWriteBufferIndex+1)%2,this.gpuFrameCount<2)return this.totalGpuDuration;if(t.mapState!=="unmapped")return this.totalGpuDuration;this.pendingResolve=this._resolveTimestamps(t);try{return await this.pendingResolve}finally{this.pendingResolve=null}}async _resolveTimestamps(e){try{await e.mapAsync(GPUMapMode.READ);const t=new BigInt64Array(e.getMappedRange()),i=t[0],s=t[1];e.unmap();const r=Number(s-i);return this.totalGpuDuration=r/1e6,this.totalGpuDuration}catch{return this.totalGpuDuration}}processGpuQueries(){if(!(!this.gl||!this.ext)){this.totalGpuDuration=0;for(let e=this.gpuQueries.length-1;e>=0;e--){const t=this.gpuQueries[e],i=this.gl.getQueryParameter(t.query,this.gl.QUERY_RESULT_AVAILABLE),s=this.gl.getParameter(this.ext.GPU_DISJOINT_EXT);if(i&&!s){const h=this.gl.getQueryParameter(t.query,this.gl.QUERY_RESULT)*1e-6;this.totalGpuDuration+=h,this.gl.deleteQuery(t.query),this.gpuQueries.splice(e,1)}}}}processWebGPUTimestamps(){this.totalGpuDuration=this.info.render.timestamp,this.totalGpuDurationCompute=this.info.compute.timestamp}beginProfiling(e){if(typeof performance<"u")try{performance.clearMarks(e),performance.mark(e)}catch(t){console.debug("Stats: Performance marking failed:",t)}}endProfiling(e,t,i){if(!(typeof performance>"u"||!t||!e))try{performance.getEntriesByName(e,"mark").length===0&&this.beginProfiling(e),performance.clearMarks(t),performance.mark(t),performance.clearMeasures(i);const r=performance.measure(i,e,t);this.totalCpuDuration+=r.duration,performance.clearMarks(e),performance.clearMarks(t),performance.clearMeasures(i)}catch(s){console.debug("Stats: Performance measurement failed:",s)}}calculateFps(){const e=performance.now();for(this.frameTimes.push(e);this.frameTimes.length>0&&this.frameTimes[0]<=e-1e3;)this.frameTimes.shift();return Math.round(this.frameTimes.length)}updateAverages(){this.addToAverage(this.totalCpuDuration,this.averageCpu),this.addToAverage(this.totalGpuDuration,this.averageGpu),this.info&&this.totalGpuDurationCompute!==void 0&&this.addToAverage(this.totalGpuDurationCompute,this.averageGpuCompute)}addToAverage(e,t){for(t.logs.push(e);t.logs.length>this.samplesLog;)t.logs.shift();for(t.graph.push(e);t.graph.length>this.samplesGraph;)t.graph.shift()}resetCounters(){this.renderCount=0,this.totalCpuDuration=0,this.beginTime=performance.now()}getData(){const e=this.averageFps.logs,t=this.averageCpu.logs,i=this.averageGpu.logs,s=this.averageGpuCompute.logs;return{fps:e.length>0?e[e.length-1]:0,cpu:t.length>0?t[t.length-1]:0,gpu:i.length>0?i[i.length-1]:0,gpuCompute:s.length>0?s[s.length-1]:0}}patchThreeWebGPU(e){const t=e.info.reset,i=this;e.info.reset=function(){i.beginProfiling("cpu-started"),t.call(this)}}patchThreeRenderer(e){const t=e.render,i=this;e.render=function(s,r){i.begin(),t.call(this,s,r),i.end()},this.threeRendererPatched=!0}dispose(){if(this.gl){if(this.activeQuery&&this.ext){try{this.gl.endQuery(this.ext.TIME_ELAPSED_EXT)}catch{}this.gl.deleteQuery(this.activeQuery),this.activeQuery=null}for(const e of this.gpuQueries)this.gl.deleteQuery(e.query);this.gpuQueries.length=0}this.gpuQuerySet&&(this.gpuQuerySet.destroy(),this.gpuQuerySet=null),this.gpuResolveBuffer&&(this.gpuResolveBuffer.destroy(),this.gpuResolveBuffer=null);for(const e of this.gpuReadBuffers)e.mapState==="mapped"&&e.unmap(),e.destroy();this.gpuReadBuffers.length=0,this.gpuFrameCount=0,this.pendingResolve=null,this.webgpuNative=!1,this.gl=null,this.ext=null,this.info=void 0,this.gpuDevice=null,this.gpuBackend=null,this.renderer=null,this.frameTimes.length=0,this.averageFps.logs.length=0,this.averageFps.graph.length=0,this.averageCpu.logs.length=0,this.averageCpu.graph.length=0,this.averageGpu.logs.length=0,this.averageGpu.graph.length=0,this.averageGpuCompute.logs.length=0,this.averageGpuCompute.graph.length=0}}class S{constructor(e,t,i){this.id=0,this.name=e,this.fg=t,this.bg=i,this.gradient=null,this.PR=Math.round(window.devicePixelRatio||1),this.WIDTH=90*this.PR,this.HEIGHT=48*this.PR,this.TEXT_X=3*this.PR,this.TEXT_Y=2*this.PR,this.GRAPH_X=3*this.PR,this.GRAPH_Y=15*this.PR,this.GRAPH_WIDTH=84*this.PR,this.GRAPH_HEIGHT=30*this.PR,this.canvas=document.createElement("canvas"),this.canvas.width=this.WIDTH,this.canvas.height=this.HEIGHT,this.canvas.style.width="90px",this.canvas.style.height="48px",this.canvas.style.position="absolute",this.canvas.style.cssText="width:90px;height:48px;background-color: transparent !important;",this.context=this.canvas.getContext("2d"),this.initializeCanvas()}createGradient(){if(!this.context)throw new Error("No context");const e=this.context.createLinearGradient(0,this.GRAPH_Y,0,this.GRAPH_Y+this.GRAPH_HEIGHT);let t;const i=this.fg;switch(this.fg.toLowerCase()){case"#0ff":t="#006666";break;case"#0f0":t="#006600";break;case"#ff0":t="#666600";break;case"#e1e1e1":t="#666666";break;default:t=this.bg;break}return e.addColorStop(0,t),e.addColorStop(1,i),e}initializeCanvas(){this.context&&(this.context.imageSmoothingEnabled=!1,this.context.font="bold "+9*this.PR+"px Helvetica,Arial,sans-serif",this.context.textBaseline="top",this.gradient=this.createGradient(),this.context.fillStyle=this.bg,this.context.fillRect(0,0,this.WIDTH,this.HEIGHT),this.context.fillStyle=this.fg,this.context.fillText(this.name,this.TEXT_X,this.TEXT_Y),this.context.fillStyle=this.bg,this.context.globalAlpha=.9,this.context.fillRect(this.GRAPH_X,this.GRAPH_Y,this.GRAPH_WIDTH,this.GRAPH_HEIGHT))}update(e,t,i=0,s=""){if(!this.context||!this.gradient)return;const r=Math.min(1/0,e),h=Math.max(t,e);this.context.globalAlpha=1,this.context.fillStyle=this.bg,this.context.fillRect(0,0,this.WIDTH,this.GRAPH_Y);const n=`${e.toFixed(i)} ${this.name}`;this.context.fillStyle=this.fg,this.context.fillText(n,this.TEXT_X,this.TEXT_Y);let u=this.TEXT_X+this.context.measureText(n).width;s&&(this.context.fillStyle="#f90",this.context.fillText(s,u,this.TEXT_Y),u+=this.context.measureText(s).width),this.context.fillStyle=this.fg,this.context.fillText(` (${r.toFixed(i)}-${parseFloat(h.toFixed(i))})`,u,this.TEXT_Y)}updateGraph(e,t){if(!this.context||!this.gradient)return;e===0&&t===0&&(t=1),t=Math.max(t,e,.1),e=Math.max(e,0);const i=Math.round(this.GRAPH_X),s=Math.round(this.GRAPH_Y),r=Math.round(this.GRAPH_WIDTH),h=Math.round(this.GRAPH_HEIGHT),n=Math.round(this.PR);this.context.drawImage(this.canvas,i+n,s,r-n,h,i,s,r-n,h),this.context.fillStyle=this.bg,this.context.fillRect(i+r-n,s,n,h);const u=Math.min(h,Math.round(e/t*h));u>0&&(this.context.globalAlpha=.9,this.context.fillStyle=this.gradient,this.context.fillRect(i+r-n,s+(h-u),n,u)),this.context.globalAlpha=1}}class le extends S{constructor(e,t,i){super(e,t,i),this.vsyncValue=0,this.SMALL_HEIGHT=9*this.PR,this.HEIGHT=this.SMALL_HEIGHT,this.WIDTH=35*this.PR,this.TEXT_Y=0*this.PR,this.canvas.height=this.HEIGHT,this.canvas.width=this.WIDTH,this.canvas.style.height="9px",this.canvas.style.width="35px",this.canvas.style.cssText=`
            width: 35px;
            height: 9px;
            position: absolute;
            top: 0;
            left: 0;
            background-color: transparent !important;
            pointer-events: none;
        `,this.initializeCanvas()}initializeCanvas(){this.context&&(this.context.imageSmoothingEnabled=!1,this.context.font="bold "+9*this.PR+"px Helvetica,Arial,sans-serif",this.context.textBaseline="top",this.context.globalAlpha=1)}update(e,t,i=0){this.context&&(this.vsyncValue=e,this.context.clearRect(0,0,this.WIDTH,this.HEIGHT),this.context.globalAlpha=1,this.context.fillStyle=this.bg,this.context.fillText(`${e.toFixed(0)}Hz`,this.TEXT_X,this.TEXT_Y))}updateGraph(e,t){}setOffset(e,t){this.canvas.style.transform=`translate(${e}px, ${t}px)`}}class A extends S{constructor(e){super(e,"#fff","#111"),this.currentBitmap=null,this.sourceAspect=1,this.initializeCanvas()}initializeCanvas(){this.context&&(this.context.imageSmoothingEnabled=!0,this.context.font="bold "+9*this.PR+"px Helvetica,Arial,sans-serif",this.context.textBaseline="top",this.context.fillStyle="#000",this.context.fillRect(0,0,this.WIDTH,this.HEIGHT),this.drawLabelOverlay())}drawLabelOverlay(){this.context&&(this.context.fillStyle="rgba(0, 0, 0, 0.5)",this.context.fillRect(0,0,this.WIDTH,this.GRAPH_Y),this.context.fillStyle=this.fg,this.context.fillText(this.name,this.TEXT_X,this.TEXT_Y))}setSourceSize(e,t){this.sourceAspect=e/t}updateTexture(e){if(!this.context)return;this.currentBitmap&&this.currentBitmap.close(),this.currentBitmap=e,this.context.fillStyle="#000",this.context.fillRect(0,0,this.WIDTH,this.HEIGHT);const t=this.WIDTH/this.HEIGHT;let i,s,r,h;this.sourceAspect>t?(i=this.WIDTH,s=this.WIDTH/this.sourceAspect,r=0,h=(this.HEIGHT-s)/2):(s=this.HEIGHT,i=this.HEIGHT*this.sourceAspect,r=(this.WIDTH-i)/2,h=0),this.context.drawImage(e,r,h,i,s),this.drawLabelOverlay()}setLabel(e){this.name=e,this.drawLabelOverlay()}update(e,t,i=0,s=""){}updateGraph(e,t){}dispose(){this.currentBitmap&&(this.currentBitmap.close(),this.currentBitmap=null)}}const x=90,T=48;class W{constructor(e,t=x,i=T){this.previewFbo=null,this.previewTexture=null,this.gl=e,this.previewWidth=t,this.previewHeight=i,this.pixels=new Uint8Array(t*i*4),this.flippedPixels=new Uint8Array(t*i*4),this.initResources()}resize(e,t){e===this.previewWidth&&t===this.previewHeight||(this.previewWidth=e,this.previewHeight=t,this.pixels=new Uint8Array(e*t*4),this.flippedPixels=new Uint8Array(e*t*4),this.dispose(),this.initResources())}initResources(){const e=this.gl;this.previewTexture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.previewTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA8,this.previewWidth,this.previewHeight,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),this.previewFbo=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this.previewFbo),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.previewTexture,0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindTexture(e.TEXTURE_2D,null)}async capture(e,t,i,s="default"){const r=this.gl,h=r.getParameter(r.READ_FRAMEBUFFER_BINDING),n=r.getParameter(r.DRAW_FRAMEBUFFER_BINDING);r.bindFramebuffer(r.READ_FRAMEBUFFER,e),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,this.previewFbo),r.blitFramebuffer(0,0,t,i,0,0,this.previewWidth,this.previewHeight,r.COLOR_BUFFER_BIT,r.LINEAR),r.bindFramebuffer(r.READ_FRAMEBUFFER,this.previewFbo),r.readPixels(0,0,this.previewWidth,this.previewHeight,r.RGBA,r.UNSIGNED_BYTE,this.pixels),r.bindFramebuffer(r.READ_FRAMEBUFFER,h),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,n);const u=this.flipY(this.pixels,this.previewWidth,this.previewHeight),l=new ImageData(new Uint8ClampedArray(u),this.previewWidth,this.previewHeight);return createImageBitmap(l)}flipY(e,t,i){const s=t*4;for(let r=0;r<i;r++){const h=r*s,n=(i-1-r)*s;this.flippedPixels.set(e.subarray(h,h+s),n)}return this.flippedPixels}removeSource(e){}dispose(){const e=this.gl;this.previewFbo&&(e.deleteFramebuffer(this.previewFbo),this.previewFbo=null),this.previewTexture&&(e.deleteTexture(this.previewTexture),this.previewTexture=null)}}class L{constructor(e,t=x,i=T){this.previewTexture=null,this.stagingBuffer=null,this.blitPipeline=null,this.sampler=null,this.bindGroupLayout=null,this.initialized=!1,this.device=e,this.previewWidth=t,this.previewHeight=i,this.pixelsBuffer=new Uint8ClampedArray(t*i*4)}resize(e,t){e===this.previewWidth&&t===this.previewHeight||(this.previewWidth=e,this.previewHeight=t,this.pixelsBuffer=new Uint8ClampedArray(e*t*4),this.previewTexture&&this.previewTexture.destroy(),this.stagingBuffer&&this.stagingBuffer.destroy(),this.previewTexture=null,this.stagingBuffer=null,this.initialized&&this.createSizeResources())}createSizeResources(){const e=this.device;this.previewTexture=e.createTexture({size:{width:this.previewWidth,height:this.previewHeight},format:"rgba8unorm",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC});const t=Math.ceil(this.previewWidth*4/256)*256;this.stagingBuffer=e.createBuffer({size:t*this.previewHeight,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})}async initResources(){if(this.initialized)return;const e=this.device;this.createSizeResources(),this.sampler=e.createSampler({minFilter:"linear",magFilter:"linear"});const t=e.createShaderModule({code:`
        @group(0) @binding(0) var texSampler: sampler;
        @group(0) @binding(1) var texInput: texture_2d<f32>;

        struct VertexOutput {
          @builtin(position) position: vec4f,
          @location(0) uv: vec2f
        }

        @vertex
        fn vertexMain(@builtin(vertex_index) vertexIndex: u32) -> VertexOutput {
          var positions = array<vec2f, 3>(
            vec2f(-1.0, -1.0),
            vec2f(3.0, -1.0),
            vec2f(-1.0, 3.0)
          );
          var uvs = array<vec2f, 3>(
            vec2f(0.0, 1.0),
            vec2f(2.0, 1.0),
            vec2f(0.0, -1.0)
          );

          var output: VertexOutput;
          output.position = vec4f(positions[vertexIndex], 0.0, 1.0);
          output.uv = uvs[vertexIndex];
          return output;
        }

        @fragment
        fn fragmentMain(@location(0) uv: vec2f) -> @location(0) vec4f {
          return textureSample(texInput, texSampler, uv);
        }
      `});this.bindGroupLayout=e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,sampler:{type:"filtering"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"float"}}]}),this.blitPipeline=e.createRenderPipeline({layout:e.createPipelineLayout({bindGroupLayouts:[this.bindGroupLayout]}),vertex:{module:t,entryPoint:"vertexMain"},fragment:{module:t,entryPoint:"fragmentMain",targets:[{format:"rgba8unorm"}]},primitive:{topology:"triangle-list"}}),this.initialized=!0}async capture(e){if(await this.initResources(),!this.previewTexture||!this.stagingBuffer||!this.blitPipeline||!this.sampler||!this.bindGroupLayout)return null;const t=this.device,i=t.createBindGroup({layout:this.bindGroupLayout,entries:[{binding:0,resource:this.sampler},{binding:1,resource:e.createView()}]}),s=t.createCommandEncoder(),r=s.beginRenderPass({colorAttachments:[{view:this.previewTexture.createView(),loadOp:"clear",storeOp:"store",clearValue:{r:0,g:0,b:0,a:1}}]});r.setPipeline(this.blitPipeline),r.setBindGroup(0,i),r.draw(3),r.end();const h=Math.ceil(this.previewWidth*4/256)*256;s.copyTextureToBuffer({texture:this.previewTexture},{buffer:this.stagingBuffer,bytesPerRow:h},{width:this.previewWidth,height:this.previewHeight}),t.queue.submit([s.finish()]),await this.stagingBuffer.mapAsync(GPUMapMode.READ);const n=new Uint8Array(this.stagingBuffer.getMappedRange());for(let l=0;l<this.previewHeight;l++){const f=l*h,d=l*this.previewWidth*4;this.pixelsBuffer.set(n.subarray(f,f+this.previewWidth*4),d)}this.stagingBuffer.unmap();const u=new ImageData(new Uint8ClampedArray(this.pixelsBuffer),this.previewWidth,this.previewHeight);return createImageBitmap(u)}dispose(){this.previewTexture&&this.previewTexture.destroy(),this.stagingBuffer&&this.stagingBuffer.destroy(),this.previewTexture=null,this.stagingBuffer=null,this.blitPipeline=null,this.sampler=null,this.bindGroupLayout=null,this.initialized=!1}}function F(a,e){return a.isWebGLRenderTarget&&a.__webglFramebuffer?{framebuffer:a.__webglFramebuffer,width:a.width||1,height:a.height||1}:null}function I(a,e){if(a.isRenderTarget&&a.texture&&e.get){const t=e.get(a.texture);return t?.texture||null}return null}class oe extends M{constructor(e={}){super(e),this.textureCaptureWebGL=null,this.textureCaptureWebGPU=null}update(){this.endProfiling("cpu-started","cpu-finished","cpu-duration"),this.info?this.processWebGPUTimestamps():this.processGpuQueries();const e=this.calculateFps();this.addToAverage(e,this.averageFps),this.updateAverages(),this.resetCounters()}getData(){return super.getData()}async captureTexture(e,t="default"){if(this.gl){if(this.textureCaptureWebGL||(this.textureCaptureWebGL=new W(this.gl)),e.isWebGLRenderTarget){const i=F(e,this.gl);if(i)return this.textureCaptureWebGL.capture(i.framebuffer,i.width,i.height,t)}if(e.framebuffer&&e.width&&e.height)return this.textureCaptureWebGL.capture(e.framebuffer,e.width,e.height,t)}if(this.gpuDevice){if(this.textureCaptureWebGPU||(this.textureCaptureWebGPU=new L(this.gpuDevice)),e.isRenderTarget&&this.gpuBackend){const i=I(e,this.gpuBackend);if(i)return this.textureCaptureWebGPU.capture(i)}if(e&&typeof e.createView=="function")return this.textureCaptureWebGPU.capture(e)}return null}disposeTextureCapture(){this.textureCaptureWebGL&&(this.textureCaptureWebGL.dispose(),this.textureCaptureWebGL=null),this.textureCaptureWebGPU&&(this.textureCaptureWebGPU.dispose(),this.textureCaptureWebGPU=null)}dispose(){this.disposeTextureCapture(),super.dispose()}}const B=class m extends M{constructor({trackGPU:e=!1,trackCPT:t=!1,trackHz:i=!1,trackFPS:s=!0,logsPerSecond:r=4,graphsPerSecond:h=30,samplesLog:n=40,samplesGraph:u=10,precision:l=2,minimal:f=!1,horizontal:d=!0,mode:C=0}={}){super({trackGPU:e,trackCPT:t,trackHz:i,trackFPS:s,logsPerSecond:r,graphsPerSecond:h,samplesLog:n,samplesGraph:u,precision:l}),this.fpsPanel=null,this.msPanel=null,this.gpuPanel=null,this.gpuPanelCompute=null,this.vsyncPanel=null,this.workerCpuPanel=null,this.texturePanels=new Map,this.texturePanelRow=null,this.textureCaptureWebGL=null,this.textureCaptureWebGPU=null,this.textureSourcesWebGL=new Map,this.textureSourcesWebGPU=new Map,this.texturePreviewWidth=x,this.texturePreviewHeight=T,this.lastRendererWidth=0,this.lastRendererHeight=0,this.textureUpdatePending=!1,this.updateCounter=0,this.lastMin={},this.lastMax={},this.lastValue={},this.VSYNC_RATES=[{refreshRate:60,frameTime:16.67},{refreshRate:75,frameTime:13.33},{refreshRate:90,frameTime:11.11},{refreshRate:120,frameTime:8.33},{refreshRate:144,frameTime:6.94},{refreshRate:165,frameTime:6.06},{refreshRate:240,frameTime:4.17}],this.detectedVSync=null,this.frameTimeHistory=[],this.HISTORY_SIZE=120,this.VSYNC_THRESHOLD=.05,this.lastFrameTime=0,this.externalData=null,this.hasNewExternalData=!1,this.isWorker=!1,this.averageWorkerCpu={logs:[],graph:[]},this.handleClick=E=>{E.preventDefault(),this.showPanel(++this.mode%this.dom.children.length)},this.handleResize=()=>{this.fpsPanel&&this.resizePanel(this.fpsPanel),this.msPanel&&this.resizePanel(this.msPanel),this.workerCpuPanel&&this.resizePanel(this.workerCpuPanel),this.gpuPanel&&this.resizePanel(this.gpuPanel),this.gpuPanelCompute&&this.resizePanel(this.gpuPanelCompute)},this.mode=C,this.horizontal=d,this.minimal=f,this.dom=document.createElement("div"),this.initializeDOM(),this._panelId=0,this.trackFPS&&(this.fpsPanel=this.addPanel(new m.Panel("FPS","#0ff","#002")),this.msPanel=this.addPanel(new m.Panel("CPU","#0f0","#020"))),this.trackGPU&&(this.gpuPanel=this.addPanel(new m.Panel("GPU","#ff0","#220"))),this.trackCPT&&(this.gpuPanelCompute=this.addPanel(new m.Panel("CPT","#e1e1e1","#212121"))),this.trackHz===!0&&(this.vsyncPanel=new le("","#f0f","#202"),this.dom.appendChild(this.vsyncPanel.canvas),this.vsyncPanel.setOffset(56,35)),this.setupEventListeners()}initializeDOM(){this.dom.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      opacity: 0.9;
      z-index: 10000;
      ${this.minimal?"cursor: pointer;":""}
    `}setupEventListeners(){this.minimal?(this.dom.addEventListener("click",this.handleClick),this.showPanel(this.mode)):window.addEventListener("resize",this.handleResize)}updateTexturePreviewDimensions(){var e,t;if(!this.renderer)return;const i=((e=this.renderer.domElement)==null?void 0:e.width)||0,s=((t=this.renderer.domElement)==null?void 0:t.height)||0;if(i===this.lastRendererWidth&&s===this.lastRendererHeight||i===0||s===0)return;this.lastRendererWidth=i,this.lastRendererHeight=s;const r=i/s,h=x/T;let n,u;if(r>h?(n=x,u=Math.round(x/r)):(u=T,n=Math.round(T*r)),n=Math.max(n,16),u=Math.max(u,16),n!==this.texturePreviewWidth||u!==this.texturePreviewHeight){this.texturePreviewWidth=n,this.texturePreviewHeight=u,this.textureCaptureWebGL&&this.textureCaptureWebGL.resize(n,u),this.textureCaptureWebGPU&&this.textureCaptureWebGPU.resize(n,u);for(const l of this.texturePanels.values())l.setSourceSize(i,s)}}onWebGPUTimestampSupported(){}onGPUTrackingInitialized(){}setData(e){if(this.externalData=e,this.hasNewExternalData=!0,!this.isWorker&&this.msPanel){this.isWorker=!0,this.workerCpuPanel=new m.Panel("WRK","#f90","#220");const t=this.msPanel.id+1;this.workerCpuPanel.id=t,this.gpuPanel&&this.gpuPanel.id>=t&&(this.gpuPanel.id++,this.resizePanel(this.gpuPanel)),this.gpuPanelCompute&&this.gpuPanelCompute.id>=t&&(this.gpuPanelCompute.id++,this.resizePanel(this.gpuPanelCompute));const i=this.msPanel.canvas;i.nextSibling?this.dom.insertBefore(this.workerCpuPanel.canvas,i.nextSibling):this.dom.appendChild(this.workerCpuPanel.canvas),this.resizePanel(this.workerCpuPanel),this._panelId++}}update(){this.externalData?this.updateFromExternalData():this.updateFromInternalData()}updateFromExternalData(){const e=this.externalData;this.endProfiling("cpu-started","cpu-finished","cpu-duration"),this.addToAverage(this.totalCpuDuration,this.averageCpu),this.totalCpuDuration=0,this.hasNewExternalData&&(this.addToAverage(e.cpu,this.averageWorkerCpu),this.addToAverage(e.fps,this.averageFps),this.addToAverage(e.gpu,this.averageGpu),this.addToAverage(e.gpuCompute,this.averageGpuCompute),this.hasNewExternalData=!1),this.renderPanels()}updateFromInternalData(){this.endProfiling("cpu-started","cpu-finished","cpu-duration"),this.webgpuNative?this.resolveTimestampsAsync():this.info?this.processWebGPUTimestamps():this.processGpuQueries(),this.updateAverages(),this.resetCounters(),this.renderPanels()}renderPanels(){var e;const t=performance.now();if(!this.isWorker){for(this.frameTimes.push(t);this.frameTimes.length>0&&this.frameTimes[0]<=t-1e3;)this.frameTimes.shift();const h=Math.round(this.frameTimes.length);this.addToAverage(h,this.averageFps)}const i=t>=this.prevTextTime+1e3/this.logsPerSecond,s=t>=this.prevGraphTime+1e3/this.graphsPerSecond,r=this.isWorker?" ⛭":"";if(this.updatePanelComponents(this.fpsPanel,this.averageFps,0,i,s,r),this.updatePanelComponents(this.msPanel,this.averageCpu,this.precision,i,s,""),this.workerCpuPanel&&this.isWorker&&this.updatePanelComponents(this.workerCpuPanel,this.averageWorkerCpu,this.precision,i,s," ⛭"),this.gpuPanel&&this.updatePanelComponents(this.gpuPanel,this.averageGpu,this.precision,i,s,r),this.trackCPT&&this.gpuPanelCompute&&this.updatePanelComponents(this.gpuPanelCompute,this.averageGpuCompute,this.precision,i,s,r),i&&(this.prevTextTime=t),s&&(this.prevGraphTime=t,this.texturePanels.size>0&&!this.textureUpdatePending&&(this.textureUpdatePending=!0,this.updateTexturePanels().finally(()=>{this.textureUpdatePending=!1})),this.captureStatsGLNodes()),this.vsyncPanel!==null){this.detectVSync(t);const h=((e=this.detectedVSync)==null?void 0:e.refreshRate)||0;i&&h>0&&this.vsyncPanel.update(h,h)}}resetCounters(){this.renderCount=0,this.totalCpuDuration=0,this.beginTime=performance.now()}resizePanel(e){e.canvas.style.position="absolute",this.minimal?e.canvas.style.display="none":(e.canvas.style.display="block",this.horizontal?(e.canvas.style.top="0px",e.canvas.style.left=e.id*e.WIDTH/e.PR+"px"):(e.canvas.style.left="0px",e.canvas.style.top=e.id*e.HEIGHT/e.PR+"px"))}addPanel(e){return e.canvas&&(this.dom.appendChild(e.canvas),e.id=this._panelId,this.resizePanel(e),this._panelId++),e}showPanel(e){for(let t=0;t<this.dom.children.length;t++){const i=this.dom.children[t];i.style.display=t===e?"block":"none"}this.mode=e}addTexturePanel(e){this.texturePanelRow||(this.texturePanelRow=document.createElement("div"),this.texturePanelRow.style.cssText=`
        position: absolute;
        top: 48px;
        left: 0;
        display: flex;
        flex-direction: row;
      `,this.dom.appendChild(this.texturePanelRow));const t=new A(e);return t.canvas.style.position="relative",t.canvas.style.left="",t.canvas.style.top="",this.texturePanelRow.appendChild(t.canvas),this.texturePanels.set(e,t),t}setTexture(e,t){this.updateTexturePreviewDimensions(),this.gl&&!this.textureCaptureWebGL&&(this.textureCaptureWebGL=new W(this.gl,this.texturePreviewWidth,this.texturePreviewHeight)),this.gpuDevice&&!this.textureCaptureWebGPU&&(this.textureCaptureWebGPU=new L(this.gpuDevice,this.texturePreviewWidth,this.texturePreviewHeight));const i=this.texturePanels.get(e);if(t.isWebGLRenderTarget&&this.gl){const s=F(t,this.gl);s&&(this.textureSourcesWebGL.set(e,{target:t,...s}),i&&i.setSourceSize(s.width,s.height));return}if(t.isRenderTarget&&this.gpuBackend){const s=I(t,this.gpuBackend);s&&(this.textureSourcesWebGPU.set(e,s),i&&t.width&&t.height&&i.setSourceSize(t.width,t.height));return}if(t&&typeof t.createView=="function"){this.textureSourcesWebGPU.set(e,t);return}}setTextureWebGL(e,t,i,s){this.updateTexturePreviewDimensions(),this.gl&&!this.textureCaptureWebGL&&(this.textureCaptureWebGL=new W(this.gl,this.texturePreviewWidth,this.texturePreviewHeight)),this.textureSourcesWebGL.set(e,{target:{isWebGLRenderTarget:!0},framebuffer:t,width:i,height:s});const r=this.texturePanels.get(e);r&&r.setSourceSize(i,s)}setTextureBitmap(e,t,i,s){const r=this.texturePanels.get(e);r&&(i!==void 0&&s!==void 0&&r.setSourceSize(i,s),r.updateTexture(t))}removeTexturePanel(e){const t=this.texturePanels.get(e);t&&(t.dispose(),t.canvas.remove(),this.texturePanels.delete(e),this.textureSourcesWebGL.delete(e),this.textureSourcesWebGPU.delete(e))}async updateTexturePanels(){if(this.updateTexturePreviewDimensions(),this.textureCaptureWebGL)for(const[e,t]of this.textureSourcesWebGL){const i=this.texturePanels.get(e);if(i){let s=t.framebuffer,r=t.width,h=t.height;t.target.isWebGLRenderTarget&&t.target.__webglFramebuffer&&(s=t.target.__webglFramebuffer,r=t.target.width||r,h=t.target.height||h);const n=await this.textureCaptureWebGL.capture(s,r,h,e);n&&i.updateTexture(n)}}if(this.textureCaptureWebGPU)for(const[e,t]of this.textureSourcesWebGPU){const i=this.texturePanels.get(e);if(i){const s=await this.textureCaptureWebGPU.capture(t);s&&i.updateTexture(s)}}}captureStatsGLNodes(){const e=this._statsGLCaptures;if(!(!e||e.size===0||!this.renderer))for(const t of e.values())t.capture&&t.capture(this.renderer)}detectVSync(e){if(this.lastFrameTime===0){this.lastFrameTime=e;return}const t=e-this.lastFrameTime;if(this.lastFrameTime=e,this.frameTimeHistory.push(t),this.frameTimeHistory.length>this.HISTORY_SIZE&&this.frameTimeHistory.shift(),this.frameTimeHistory.length<60)return;const i=this.frameTimeHistory.reduce((u,l)=>u+l)/this.frameTimeHistory.length,s=this.frameTimeHistory.reduce((u,l)=>u+Math.pow(l-i,2),0)/this.frameTimeHistory.length;if(Math.sqrt(s)>2){this.detectedVSync=null;return}let h=null,n=1/0;for(const u of this.VSYNC_RATES){const l=Math.abs(i-u.frameTime);l<n&&(n=l,h=u)}h&&n/h.frameTime<=this.VSYNC_THRESHOLD?this.detectedVSync=h:this.detectedVSync=null}updatePanelComponents(e,t,i,s,r,h=""){if(!e||t.logs.length===0)return;const n=String(e.id);n in this.lastMin||(this.lastMin[n]=1/0,this.lastMax[n]=0,this.lastValue[n]=0);const u=t.logs[t.logs.length-1];this.lastMax[n]=Math.max(...t.logs),this.lastMin[n]=Math.min(this.lastMin[n],u),this.lastValue[n]=this.lastValue[n]*.7+u*.3;const l=Math.max(Math.max(...t.logs),...t.graph.slice(-this.samplesGraph));this.updateCounter++,s&&e.update(this.lastValue[n],this.lastMax[n],i,h),r&&e.updateGraph(u,l)}updatePanel(e,t,i=2){if(!e||t.logs.length===0)return;const s=performance.now();e.name in this.lastMin||(this.lastMin[e.name]=1/0,this.lastMax[e.name]=0,this.lastValue[e.name]=0);const r=t.logs[t.logs.length-1],h=Math.max(...t.logs.slice(-30));this.lastMin[e.name]=Math.min(this.lastMin[e.name],r),this.lastMax[e.name]=Math.max(this.lastMax[e.name],r),this.lastValue[e.name]=this.lastValue[e.name]*.7+r*.3;const n=Math.max(h,...t.graph.slice(-this.samplesGraph));this.updateCounter++,this.updateCounter%(this.logsPerSecond*2)===0&&(this.lastMax[e.name]=h,this.lastMin[e.name]=r),e.update&&(s>=this.prevCpuTime+1e3/this.logsPerSecond&&e.update(this.lastValue[e.name],r,this.lastMax[e.name],n,i),s>=this.prevGraphTime+1e3/this.graphsPerSecond&&(e.updateGraph(r,n),this.prevGraphTime=s))}get domElement(){return this.dom}dispose(){this.minimal?this.dom.removeEventListener("click",this.handleClick):window.removeEventListener("resize",this.handleResize),this.textureCaptureWebGL&&(this.textureCaptureWebGL.dispose(),this.textureCaptureWebGL=null),this.textureCaptureWebGPU&&(this.textureCaptureWebGPU.dispose(),this.textureCaptureWebGPU=null);for(const t of this.texturePanels.values())t.dispose();this.texturePanels.clear(),this.textureSourcesWebGL.clear(),this.textureSourcesWebGPU.clear();const e=this._statsGLCaptures;if(e){for(const t of e.values())t.dispose&&t.dispose();e.clear()}this.texturePanelRow&&(this.texturePanelRow.remove(),this.texturePanelRow=null),this.dom.remove(),this.fpsPanel=null,this.msPanel=null,this.gpuPanel=null,this.gpuPanelCompute=null,this.vsyncPanel=null,this.workerCpuPanel=null,this.frameTimeHistory.length=0,this.averageWorkerCpu.logs.length=0,this.averageWorkerCpu.graph.length=0,super.dispose()}};B.Panel=S;B.PanelTexture=A;self.onerror=function(a){console.error("[worker] ❌ Global error:",{message:a.message,filename:a.filename,lineno:a.lineno,colno:a.colno,error:a.error,event:a}),self.postMessage({type:"worker-error",error:a.error?String(a.error):String(a),source:a.filename,lineno:a.lineno,colno:a.colno})};self.onunhandledrejection=a=>{console.error("[worker] ❌ Unhandled rejection:",a.reason),self.postMessage({type:"worker-error",error:String(a.reason),source:"unhandled-rejection"})};let o=null,g=null,c=null,y=null,b=null,P=null,k=null,R=null;self.onmessage=async a=>{switch(a.data.type){case"init":await pe(a.data.canvas,a.data.width,a.data.height);break;case"camera":R=a.data.matrix;break;case"resize":ce(a.data.width,a.data.height);break}};async function pe(a,e,t){k=new p.Clock,o=new p.WebGPURenderer({canvas:a,antialias:!0}),o.setSize(e,t,!1),o.toneMapping=p.ACESFilmicToneMapping,g=new p.Scene,g.backgroundNode=v.y.mix(_(8900331),_(4886745)),c=new p.PerspectiveCamera(40,e/t,1,100),c.position.set(5,2,8),g.add(new p.AmbientLight(15856127,1.5));const i=new p.DirectionalLight(16777215,2);i.position.set(5,10,5),g.add(i),await o.init(),P=new oe({trackGPU:!0}),await P.init(o);const s=Y(g,c,{minFilter:p.NearestFilter,magFilter:p.NearestFilter});s.setMRT(O({output:q,normal:$(j),diffuse:Z,position:J}));const r=s.getTexture("normal"),h=s.getTexture("diffuse");s.getTexture("position"),r.type=h.type=p.UnsignedByteType,b=new p.PostProcessing(o),b.outputColorTransform=!1,b.outputNode=K(()=>{const u=s.getTextureNode("output"),l=s.getTextureNode("normal"),f=s.getTextureNode("diffuse"),d=s.getTextureNode("position"),C=s.getTextureNode("depth");f.toStatsGL("Diffuse"),l.toStatsGL("Normal"),d.toStatsGL("Position"),s.getLinearDepthNode().toStatsGL("Depth");const E=w(f,l,G(.2,v.x)),z=w(E,u.renderOutput(),G(.4,v.x)),N=w(z,d,G(.6,v.x));return w(N,C,G(.8,v.x))})(),new ae().load("/Flamingo.glb",u=>{const l=u.scene;l.position.set(1,1,0),l.scale.set(.025,.025,.025),g.add(l),y=new p.AnimationMixer(l),y.clipAction(u.animations[0]).play(),self.postMessage({type:"ready"}),o.setAnimationLoop(fe)},void 0,u=>{console.error("Error loading model:",u),self.postMessage({type:"error",message:u.message})})}function ce(a,e){!o||!c||(c.aspect=a/e,c.updateProjectionMatrix(),o.setSize(a,e,!1))}async function fe(){if(!o||!b)return;const a=k.getDelta();y&&y.update(a),R&&(c.matrixWorld.fromArray(R),c.matrixWorldInverse.copy(c.matrixWorld).invert(),c.matrixWorld.decompose(c.position,c.quaternion,c.scale),R=null),P.begin(),b.render(),o.resolveTimestampsAsync(p.TimestampQuery.RENDER),P.end(),P.update();const e=P.getData();self.postMessage({type:"stats",data:e});const t=await ue(o);for(const{name:i,bitmap:s}of t)self.postMessage({type:"texture",name:i,bitmap:s,width:o.domElement.width,height:o.domElement.height},[s])}
